---
###[ Fix Filesystem Mount Order ]##############################################
- name: Fix Filesystem Mount Order Block
  block:
  - name: Create zfs-list cache directory
    file:
      path: /mnt/etc/zfs/zfs-list.cache
      state: directory
      mode: '0755'

  - name: Create bpool cache file
    file:
      path: "/mnt/etc/zfs/zfs-list.cache/{{boot_pool_name}}"
      state: touch
      mode: '0644'

  - name: Create rpool cache file
    file:
      path: "/mnt/etc/zfs/zfs-list.cache/{{root_pool_name}}"
      state: touch
      mode: '0644'

  - name: Run chroot command to create symbolic link zed
    command: "{{chroot_cmd}} bash -c 'ln -s /usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d'"

  - name: Run chroot command to start zed service
    command: "{{chroot_cmd}} bash -c 'zed -p /tmp/zed.pid'"

  - name: sleep 5 seconds for zed service to do its work
    wait_for:
      timeout: 5

  - name: Checking stats on bpool cache
    stat:
      path: "/mnt/etc/zfs/zfs-list.cache/{{boot_pool_name}}"
    register: filestat

  - name: Run chroot command to attempt forced cache update, bpool cache was empty
    command: "{{chroot_cmd}} bash -c 'zfs set canmount=noauto {{boot_pool_name}}/BOOT/{{distro_name}}_{{UUID.stdout}}'"
    when:
      - filestat.stat.size|int == 0

  - name: Checking stats on rpool cache
    stat:
      path: "/mnt/etc/zfs/zfs-list.cache/{{root_pool_name}}"
    register: filestat

  - name: Run chroot command to attempt forced cache update, rpool cache was empty
    command: "{{chroot_cmd}} bash -c 'zfs set canmount=noauto {{root_pool_name}}/ROOT/{{distro_name}}_{{UUID.stdout}}'"
    when:
      - filestat.stat.size|int == 0

  - name: Run chroot command to stop ZED service
    command: "{{chroot_cmd}} bash -c 'kill $(cat /tmp/zed.pid)'"

  - name: Remove chroot based mount references from bpool zfs-list.cache 
    replace:
      path: "/mnt/etc/zfs/zfs-list.cache/{{boot_pool_name}}"
      regexp: '(?m)/mnt/?'
      replace: '/'

  - name: Remove chroot based mount references from rpool zfs-list.cache 
    replace:
      path: "/mnt/etc/zfs/zfs-list.cache/{{root_pool_name}}"
      regexp: '(?m)/mnt/?'
      replace: '/'

  when:
    - ansible_nodename != "localhost"
  tags:
    - fix_mount_order
###############################################################################
