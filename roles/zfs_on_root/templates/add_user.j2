#!/bin/bash
if [[ "$#" -ne 1 ]]; then
  echo "You must provide a username of a home directory to create."
  exit 1
else
    if [[ -d /home/${1} ]]; then
      echo "Home directory ${1} already exists."
      exit 1
    else
      UUID=$(dd if=/dev/urandom of=/dev/stdout bs=1 count=100 2>/dev/null |  tr -dc 'a-z0-9' | cut -c-6)
      ROOT_DS=$(zfs list -o name | awk '/ROOT\/{{distro_name}}_/{print $1;exit}')
      zfs create -o com.ubuntu.zsys:bootfs-datasets=$ROOT_DS \
          -o canmount=on -o mountpoint=/home/${1} \
          {{root_pool_name}}/USERDATA/${1}_${UUID}
      cp -a /etc/skel/. /home/${1}
      chown -R ${1}:${1} /home/${1}

      adduser ${1}
      cp -a /etc/skel/. /home/${1}
      chown -R ${1}:${1} /home/${1}
    fi
fi
