#!/bin/bash
#
# This is a helper script generated by the Ansible ZFS on Root script showing
# how the partitions on your drivers were created.
#
# Should you need to replace a drive or add new drives, you would likely want
# to partition them in the same way as your existing drives.
#############################################################################

# ---------------------------------------------------------------------------
# Define device name to use:
DISK_DEVICE=/dev/disk/by-id/PUT_YOUR_DEVICE_NAME_HERE
# ---------------------------------------------------------------------------

if [[ -b ${DISK_DEVICE} ]]; then
  echo ${DISK_DEVICE} is a valid block device.

# ---------------------------------------------------------------------------
# DANGER: This script does not wipe existing disk partitions.  However, Should
#         you choose to accept this mission, these are the command this script
#         would have used:

# mdadm --zero-superblock --force ${DISK_DEVICE}
# mdadm --zero-superblock --force ${DISK_DEVICE}-part2
# sgdisk --zap-all ${DISK_DEVICE}
# ---------------------------------------------------------------------------

  if ls ${DISK_DEVICE}-part? 2>&1 > /dev/null; then
    echo Partitions detected, you must remove partitionms from this device
    echo before you can use this script.
    echo
    ls -l ${DISK_DEVICE}-part?
    echo
    exit 1
  else
    echo No partitions detected.
  fi
else
  echo ${DISK_DEVICE} is not a valid block device.
  echo
  echo You must update the script and to use a valid device located in:
  echo "/dev/disk/by-id"
  exit 1
fi

# ---------------------------------------------------------------------------
# Create UEFI Boot Partition:
sgdisk {{ uefi_partition_flags }} ${DISK_DEVICE}

# Create BIOS Boot Partition:
sgdisk {{ bios_partition_flags }} ${DISK_DEVICE}

{% if enable_swap_partitions|default(true)|bool == true %}
# Create Swap Partition
sgdisk {{(boot_pool_type == 'raidz')|ternary(raidz_multi_disk_swap_flags, single_disk_or_mirror_swap_flags)}} ${DISK_DEVICE}
{% else %}
# NOTE: SWAP Partitions Were not enabled, thus not created.
{% endif %}

# Create Boot Pool Partition
sgdisk {{(boot_pool_type == 'raidz')|ternary(raidz_multi_disk_boot_partition_flags,single_disk_or_mirror_boot_partition_flags)}} ${DISK_DEVICE}

# Create Root Pool Partition
sgdisk {{ root_partition_flags }} ${DISK_DEVICE}
# ---------------------------------------------------------------------------
