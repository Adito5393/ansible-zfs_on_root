---
###[ Final Cleanup ]###########################################################
- name: Final Cleanup Block
  block:

  - name: Run chrooted command to update timezone setting
    command: "timedatectl set-timezone {{timezone_value}}"

  - name: Disable root password
    user:
      name: 'root'
      password: '*'

  - name:  Update grub - uncomment GRUB_TIMEOUT_STYLE=hidden
    replace:
      path: /etc/default/grub
      regexp: '^#GRUB_TIMEOUT_STYLE=hidden'
      replace: 'GRUB_TIMEOUT_STYLE=hidden'

  - name:  Update grub - enable quiet splash screen
    replace:
      path: /etc/default/grub
      regexp: '^GRUB_CMDLINE_LINUX_DEFAULT=.*'
      replace: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash init_on_alloc=0"'

  - name:  Update grub - Comment out GRUB_TERMINAL=console
    replace:
      path: /etc/default/grub
      regexp: '^GRUB_TERMINAL=console'
      replace: '#GRUB_TERMINAL=console'

  - name: Running update-grub
    command: "update-grub"
      
  when:
    - ansible_nodename != "localhost"
  tags:
    - final_cleanup
###############################################################################

###[ Last Reboot of Remote System ]##########################################
- name: Last Reboot of Remote System Block
  block:
  - pause:
      prompt: |
        ##########################################################
        # {{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }} is complete.
        ##########################################################

          IMPORTANT: Copy the SSH for your non-root user NOW! After the next reboot 
                     SSH based password logins may NOT work.

          ssh-copy-id -i ~/.ssh/<public_key> {{regular_user_accounts[0].user_id}}@{{(ansible_ssh_host|default(ansible_host))|default(inventory_hostname)}}

          When completed, press ENTER to wrap up this installation:

          * Root password is now disabled (login as "{{regular_user_accounts[0].user_id}}" and use sudo instead).
          * Ansible password is now disabled, only SSH key connection allowed.
          * Graphical Boot Process is be enabled.
          {% if root_pool_encryption|default(false)|bool == true %}{% if enable_dropbear_with_busybox_support|bool == true %}

          * Dropbear has been installed and configured, example connection:
          ssh -i {{rsa_public_key_for_dropbear[0]}} -p {{apply_dropbear_settings.DROPBEAR_PORT|default("22")}} {{(ansible_ssh_host|default(ansible_host))|default(inventory_hostname)}}
          {% endif %}{% endif %}

          * NOTE: You will likely have to remove "{{(ansible_ssh_host|default(ansible_host))|default(inventory_hostname)}}" from your ~/.ssh/known_hosts

          Press ENTER for last reboot

  - name: Commencing Last Reboot, installation complete....
    reboot:
      pre_reboot_delay: 30
      reboot_timeout: 3600

  tags:
    - final_cleanup
###############################################################################